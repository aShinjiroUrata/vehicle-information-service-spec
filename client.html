<!-- client.html  -->
<html>
<head>
  <meta charset="UTF-8">
  <title>VSSS client</title>
  <style>
    div#msg { height:600px; width:1500px; background-color:lightgrey; font-size:14px;}
    .val_area { height: 20px; width:150px; background-color:lightgrey; font-size:14px; display:inline-block;}
    #server_info {height:20px; width:500px; font-size:13px;}
  </style>
</head>

<body>
  <h3> Vehicle Signal Server Spec Trial Implementaion </h3>
  <span id="server_info"></span>
  <br>
  <br><button onclick="wsConnect();">ws connect</button><button onclick="wsDisconnect();">ws disconnect</button>
  <span class="val_area" id="msg_connect"></span>
  <br>
  <br><button onclick="wsGetSpeed();">get speed</button>
  <span class="val_area" id="msg_get_speed" ></span>
  <br><button onclick="wsGetEngineRPM();">get engine RPM</button>
  <span class="val_area" id="msg_get_rpm"></span>
  <br><button onclick="wsGetSteeringAngle();">get steering angle</button>
  <span class="val_area" id="msg_get_steer"></span>
  <br>
  <br><button onclick="btnSubscribeSpeed();">subscribe speed</button><button onclick="btnUnsubscribeSpeed();">unsubscribe</button>
  <span class="val_area" id="msg_sub_speed"></span>
  <br><button onclick="btnSubscribeEngineRpm();">subscribe engine RPM</button><button onclick="btnUnsubscribeEngineRpm();">unsubscribe</button>
  <span class="val_area" id="msg_sub_rpm"></span>
  <br><button onclick="btnSubscribeSteerAngle();">subscribe steer angle</button><button onclick="btnUnsubscribeSteerAngle();">unsubscribe</button>
  <span class="val_area" id="msg_sub_steer"></span>
  <br><br>
  <button onclick="clearMsgArea();">clearMsgArea</button>
  <div id="msg"></div>
  <script type="text/javascript">
  //TODO
  // sessionのインスタンスごとにIdテーブル等を管理したい

  var WSSvrIP = "10.5.162.79";
  var WSSvrPort = "8071";

  var g_vehicle = null; // only one WebSocket connection is allowed
  var g_reqTable = null;
  var g_ui = {
    speedReqId : null,
    engineRpmReqId : null,
    steerAngleReqId : null,
    clearSubscribeBtnLock : function(reqId) {
      if (reqId == this.speedReqId) {
        this.speedReqId = null;
        return true;
      } else if (reqId == this.engineRpmReqId) {
        this.engineRpmReqId = null;
        return true;
      } else if (reqId == this.steerAngleReqId) {
        this.steerAngleReqId = null;
        return true;
      } else {
        return false;
      }
    },
    clearSubscribeBtnLockAll : function() {
      this.speedReqId = null;
      this.engineRpmReqId = null;
      this.steerAngleReqId = null;
    }
  };

  // =========================
  // == define RequestTable ==
  // =========================
  // memo: all requests should be stored in this table
  g_reqTable = {
    subIdHash: {},
    requestHash: {},

    addReqByReqId: function(reqId, reqObj) {
      showInMsgArea("addReqByReqId: reqId="+reqId);
      if (this.requestHash[reqId] != undefined) {
        showInMsgArea("--:Error: requestId already used. reqId="+reqId);
        return false;
      }
      this.requestHash[reqId] = reqObj;
      showInMsgArea("--:EntryNum=" + Object.keys(this.requestHash).length);
      return true;
    },

    delReqByReqId: function(reqId) {
      showInMsgArea("delReqByReqId: reqId="+reqId);
      if (this.requestHash[reqId] == undefined)
        return false;
      var subId = this.requestHash[reqId].subscriptionId;
      delete this.requestHash[reqId];

      // requestはsubIdを持たない場合もある
      // TODO: unsubscribeのエントリはsubIdHashには登録しない
      //   unsubの場合、subId == undefinedになるから現状の仕組みで問題ない
      if (subId != undefined)
        delete this.subIdHash[subId];
      showInMsgArea("--:entry deleted. reqId="+reqId+" ,subId="+subId);
      return true;
    },

    getReqByReqId: function(reqId) {
      //showInMsgArea("getReqByReqId: reqId="+reqId);
      if (this.requestHash[reqId] == undefined) return false;
      return this.requestHash[reqId];
    },

    getReqBySubId: function(subId) {
      //showInMsgArea("getReqBySubId: subId="+subId);
      // subscribeとunsubは同じsubIdを使用する
      // 一つのsubIdでsubIdHashに2件登録されるのは不都合。
      // unsubのエントリはsubIdHashに登録する必要はなさそうなのでそうしてみる
      var reqId = this.subIdHash[subId];
      if (reqId == undefined) return false;
      return this.getReqByReqId(reqId);
    },

    setSubIdToReq: function(reqId, subId) {
      showInMsgArea("setSubIdToReq: reqId="+reqId+" subId="+subId);
      // this func is only for 'subscribe' request.
      // should not be used for 'unsubscribe' request, otherwise
      // a subscriptionId may be used twice in hash array.
      if (this.requestHash[reqId] == undefined) {
        showInMsgArea("--:Error: this requestId entry not exits. reqId="+reqId);
        return false;
      }
      if (this.subIdHash[subId] != undefined) {
        showInMsgArea("--:Error: this subscriptionId already used. subId="+subId);
        return false;
      }
      this.requestHash[reqId].subscriptionId = subId;
      //this.dispRequestHash();
      this.subIdHash[subId] = reqId; // for cross reference.
      //this.dispSubIdHash();
      return true;
    },
    getSubIdByReqId: function(rId) {
      var obj = this.requestHash[rId];
      if (obj == undefined) return null;
      return obj.subscriptionId;
    },
    getReqIdBySubId: function(sId) {
      var reqId = this.subIdHash[sId]; //subIdHash はダブリなどないはず
      if (reqId == undefined) return null;
      return reqId;
    },
    clearReqTable: function() {
      showInMsgArea("clearReqTable:");
      for (var i in this.requestHash) {
        showInMsgArea("--:delete : " + i);
        delete this.requestHash[i];
      }
      for (var i in this.subIdHash) {
        showInMsgArea("--:delete : " + i);
        delete this.subIdHash[i];
      }
      g_ui.clearSubscribeBtnLockAll();
    },
    dispRequestHash: function() {
      showInMsgArea("dispRequestHash:");
      for (var i in this.requestHash) {
        showInMsgArea("--:reqId="+i+", req="+JSON.stringify(this.requestHash[i]));
      }
    },
    dispSubIdHash: function() {
      showInMsgArea("dispSubIdHash:");
      for (var i in this.subIdHash) {
        showInMsgArea("--:subId="+i+", reqId="+this.subIdHash[i]);
      }
    }
  };

  // ===================
  // == event handler ==
  // ===================
  function onWsOpen() {
    showInMsgArea("onWsOpen: Connection opened");
  }
  function onWsClose() {
    showInMsgArea("onWsClose: Connection closed");
  }

  function onWsMessage(event) {
    showInMsgArea("onWsMessage: ");
    showInMsgArea("--: <== " + event.data);

    var msg = JSON.parse(event.data);
    var reqObj=null, action=null, reqId=null, subId=null;
    if (msg.requestId != undefined) {
      reqId = msg.requestId;
      reqObj = g_reqTable.getReqByReqId(reqId);
    } else if (msg.subscriptionId != undefined) {
      subId = msg.subscriptionId;
      reqObj = g_reqTable.getReqBySubId(subId);
    }
    action = reqObj.action;
    showInMsgArea("--:action="+action);

    // case of 'get'
    if (action === "get") {
      showMsgByActionAndPath(msg.value, reqObj.action, reqObj.path);
      // delete request from requestHash. delete even in error case
      g_reqTable.delReqByReqId(reqId);
    // case of 'set'
    } else if (action === "set") {
      //TODO

    // case of 'subscribe'
    } else if (action === "subscribe") {
      // memo: subscribeの場合は、msgはresponseかnotification
      //       response => reqId, subId両方あり
      //       notifica => subIdのみあり
      //       subscribeのrequestHashエントリの削除はunsubscribeによる

      if (isSubscribeSuccessResponse(msg)) {
        // subscribeSuccessResponseの場合
        // subIdをrequestTableに追加する
        //showInMsgArea("--:msgtype: SubscribeSuccessResponse");
        g_reqTable.setSubIdToReq(msg.requestId, msg.subscriptionId);

      } else if (isSubscribeErrorResponse(msg)) {
        // subscribeErrorRespの場合
        // subscribe失敗したので、requestTalbeからエントリ削除
        //showInMsgArea("--:msgtype: SubscribeErrorResponse");
        g_reqTable.delReqByReqId(msg.requestId);

      } else if (isSubscriptionNotification(msg)) {
        // subscribeNotificationの場合
        // subIdしか持っていない
        // valueの通知を受けてハンドラに引き渡す
        //showInMsgArea("--:msgtype: SubscriptionNotification");
        // notification で valueが通知されたので表示する
        showMsgByActionAndPath(msg.value, reqObj.action, reqObj.path);

      } else if (isSubscriptionNotificationError(msg)) {
        //showInMsgArea("--:msgtype: SubscriptionNotificationError");
        // noting to do special here. continu subscribe.
      } else {
        // ここには来ないはず
        //showInMsgArea("--:msgtype: Subscribe: Unknown");
      }

    // case of 'unsubscribe'
    } else if (action === "unsubscribe") {
      //memo: unsubの場合は msgにはreqId, subId両方存在する
      // ただし、subIdは、subscribeとunsubscribeで同じものを使用する
      // つまり、g_reqTableのなかでsubIdはuniqueではない

      if (msg.error != undefined) {
        // unsub失敗。unsubのリクエスト削除は行う
        // subscribeのリクエストは削除しない
        g_reqTable.delReqByReqId(reqId);
      } else {
        // unsub成功。unsubのリクエスト削除は行う
        // subscribeのリクエスト削除も行う
        var reqId = msg.requestId;
        var targ_subId = msg.subscriptionId; //unsub対象のsubscribeのsubId
        var targ_reqId = g_reqTable.getReqIdBySubId(targ_subId); //subscribeのreqId

        g_reqTable.delReqByReqId(targ_reqId); //subscribeのエントリを削除
        g_reqTable.delReqByReqId(reqId);      //unsubのエントリを削除

        //ボタンlock用のフラグもクリア
        g_ui.clearSubscribeBtnLock(targ_reqId);
      }

    // TODO: set, authorize, getVSS
    } else {
      // others
    }
  }

  // ================
  // == UI handler ==
  // ================
  function wsConnect() {
    showInMsgArea("wsConnect:");
    if (g_vehicle != null) {
      showInMsgArea("--:WebSocket already open");
      return;
    }
    var url = "ws://" + WSSvrIP + ":" + WSSvrPort;
    g_vehicle = new WebSocket(url);
    g_vehicle.onopen = onWsOpen;
    g_vehicle.onclose = onWsClose;
    g_vehicle.onmessage = onWsMessage;
    showConnectMsg("WS Connected");
  }
  function wsDisconnect() {
    showInMsgArea("wsDisconnect:");
    if (g_vehicle === null) {
      showInMsgArea("--:WebSocket not connected");
      return;
    }
    g_vehicle.close();
    g_vehicle = null;
    //clearIdTable();
    g_reqTable.clearReqTable();
    showConnectMsg("WS Disconnected");
  }

  // === get ===
  function wsGetItem(path) {
    showInMsgArea("wsGetItem:");
    if (g_vehicle != null && g_vehicle.readyState === 1) {
      var reqId = getUniqueReqId();
      var req = {"action": "get", "path": path, "requestId":reqId};
      g_reqTable.addReqByReqId(reqId, req);
      var json_str = JSON.stringify(req);
      g_vehicle.send(json_str);
      showInMsgArea("--: ==> " + json_str);
    }
  }
  function wsGetSpeed() {
    wsGetItem("Signal.Drivetrain.Transmission.Speed");
  }
  function wsGetEngineRPM() {
    wsGetItem("Signal.Drivetrain.InternalCombustionEngine.RPM");
  }
  function wsGetSteeringAngle() {
    wsGetItem("Signal.Chassis.SteeringWheel.Angle");
  }

  // === subscribe/unsubscribe ===
  function wsSubscribeItem(path, reqId) {
    showInMsgArea("wsSubscribeItem: reqId = " + reqId);
    if (g_vehicle != null && g_vehicle.readyState === 1) {
      var req ={"action": "subscribe", "path": path, "filters":"", "requestId":reqId};
      var json_str = JSON.stringify(req);
      g_vehicle.send(json_str);
      showInMsgArea("--: ==> " + json_str);
      g_reqTable.addReqByReqId(reqId, req);
      return true;
    } else {
      return false;
    }
  }
  function wsUnsubscribeItem(path, subId) {
    showInMsgArea("wsUnsubscribeItem: subId=" + subId);
    if (g_vehicle != null && g_vehicle.readyState === 1) {
      var reqId = getUniqueReqId(); //reqIdはunsub用に新しいものを使用
      var req = {"action": "unsubscribe", "requestId":reqId, "subscriptionId":subId};
      var json_str = JSON.stringify(req);
      g_vehicle.send(json_str);
      showInMsgArea("--: ==> " + json_str);
      g_reqTable.addReqByReqId(reqId, req);
    }
  }

  function btnSubscribeSpeed() {
    if (g_ui.speedReqId != null) {
      showInMsgArea("Speed is already subscribed");
      return;
    }
    g_ui.speedReqId = getUniqueReqId();
    var path = "Signal.Drivetrain.Transmission.Speed";
    var ret = wsSubscribeItem(path, g_ui.speedReqId);
    if (!ret) g_ui.speedReqId = null;
  }
  function btnUnsubscribeSpeed() {
    var path = "Signal.Drivetrain.Transmission.Speed";
    var targ_subId = g_reqTable.getSubIdByReqId(g_ui.speedReqId); //unsub対象のsubIdを取得
    wsUnsubscribeItem(path, targ_subId);
  }

  function btnSubscribeEngineRpm() {
    if (g_ui.engineRpmReqId != null) {
      showInMsgArea("EngineRpm is already subscribed");
      return;
    }
    g_ui.engineRpmReqId = getUniqueReqId();
    var path = "Signal.Drivetrain.InternalCombustionEngine.RPM"
    var ret = wsSubscribeItem(path, g_ui.engineRpmReqId);
    if (!ret) g_ui.engineRpmReqId = null;
  }
  function btnUnsubscribeEngineRpm() {
    var path = "Signal.Drivetrain.InternalCombustionEngine.RPM"
    var targ_subId = g_reqTable.getSubIdByReqId(g_ui.engineRpmReqId); //unsub対象のsubIdを取得
    wsUnsubscribeItem(path, targ_subId);
  }

  function btnSubscribeSteerAngle() {
    if (g_ui.steerAngleReqId != null) {
      showInMsgArea("Steering Angle is already subscribed");
      return;
    }
    g_ui.steerAngleReqId = getUniqueReqId();
    var path = "Signal.Chassis.SteeringWheel.Angle";
    var ret = wsSubscribeItem(path, g_ui.steerAngleReqId);
    if (!ret) g_ui.steerAngleReqId = null;
  }
  function btnUnsubscribeSteerAngle() {
    var path = "Signal.Chassis.SteeringWheel.Angle";
    var targ_subId = g_reqTable.getSubIdByReqId(g_ui.steerAngleReqId); //unsub対象のsubIdを取得
    wsUnsubscribeItem(path, targ_subId);
  }

  // *** Authorize *** [TODO]
  // *** getVSS ***    [TODO]
  // *** set ***       [TODO]
  // *** Ohters ***    [TODO]

  // == subscribe helper funcs ==
  // to detect type of Json message
  function isSubscribeSuccessResponse(msg) {
    // This is subscribeSuccessResponse if ...
    // must exist    : (action), requestId, subscriptionId, (timestamp)
    // must not exist: error, value
    if (msg.action === "subscribe" && msg.requestId != undefined && msg.subscriptionId != undefined &&
        msg.error == undefined && msg.value == undefined)
      return true;
    else
      return false;
  }
  function isSubscribeErrorResponse(msg) {
    // This is subscribeErrorResponse if ...
    // must exist    : (path), requestId, error,(timestamp)
    // must not exist: (action), subscriptionId, value
    if (msg.path != undefined && msg.requestId != undefined && msg.error != undefined && 
        msg.action == undefined && msg.subscriptionId == undefined && msg.value == undefined)
      return true;
    else
      return false;

  }
  function isSubscriptionNotification(msg) {
    // This is subscriptionNotification if ..
    // must exist    : subscriptionId, (path), value, (timestamp)
    // must not exist: error, (requestId), (action)
    if (msg.subscriptionId != undefined && msg.value != undefined &&
        msg.error == undefined)
      return true;
    else
      return false;
  }
  function isSubscriptionNotificationError(msg) {
    // This is subscriptionNotificationError if ..
    // following members exist    : subscriptionId, (path), error, (filters), (timestamp)
    // following members not exist: value, (requestId), (action)
    if (msg.subscriptionId != undefined && msg.error != undefined &&
        msg.value == undefined)
      return true;
    else
      return false;
  }

  // ===================
  // == Utility funcs ==
  // ===================
  // to get unique ID to use as requestID
  function getUniqueReqId() {
    // create semi-uniquID (for implementation easyness) as timestamp(milli sec)+random string
    // uniqueness is not 100% guaranteed.
    var strength = 1000;
    var uniq = new Date().getTime().toString(16) + Math.floor(strength*Math.random()).toString(16);
    return "reqid-"+uniq;
  }

  function showInMsgArea(msgText) {
    var targ = document.getElementById('msg');
    var oldText = targ.innerHTML;
    oldText = oldText.substring(0, 5000);
    var newText = msgText + "<br>" + oldText;
    targ.innerHTML = newText;
  }

  function showMsgById(msgText, idTarg) {
    var targ = document.getElementById(idTarg);
    targ.innerHTML = msgText;
  }

  function showMsgByActionAndPath(value, action, path) {
    var targ_id = null;
    if (path === "Signal.Drivetrain.Transmission.Speed" ) {
      if (action === "get")
        targ_id = "msg_get_speed";
      else if (action === "subscribe")
        targ_id = "msg_sub_speed";

    } else if (path === "Signal.Drivetrain.InternalCombustionEngine.RPM" ) {
      if (action === "get")
        targ_id = "msg_get_rpm";
      else if (action === "subscribe")
        targ_id = "msg_sub_rpm";
    } else if (path === "Signal.Chassis.SteeringWheel.Angle" ) {
      if (action === "get")
        targ_id = "msg_get_steer";
      else if (action === "subscribe")
        targ_id = "msg_sub_steer";
    }
    var targ = document.getElementById(targ_id);
    targ.innerHTML = value;
  }

  function showConnectMsg(msgText) {
    var targ = document.getElementById('msg_connect');
    targ.innerHTML = msgText;
  }
  function clearMsgArea() {
    var targ = document.getElementById('msg');
    targ.innerHTML = "";
  }

  // =============
  // == UI init ==
  // =============
  (function init() {
    var svr_area = document.getElementById("server_info");
    svr_area.innerHTML = "Server IP:" + WSSvrIP + "  WebSocket Port:" + WSSvrPort;

    var msg_areas = document.getElementsByClassName("val_area");
    for (var i=0; i<msg_areas.length; i++) {
      msg_areas.item(i).innerHTML = "---";
    }
  })();

  </script>
</body>
</html>

